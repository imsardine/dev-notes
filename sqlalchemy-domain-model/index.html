<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="canonical" href="https://imsardine.github.io/dev-notes/sqlalchemy-domain-model/">
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>SQLAlchemy / Domain Model - 建造以學習 | 在電梯裡遇見雙胞胎</title>
    

    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/3.003/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.min.css">
    <link href="../cinder_extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.28/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="..">建造以學習 | 在電梯裡遇見雙胞胎</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/imsardine/dev-notes/blob/source/docs/sqlalchemy-domain-model.md">Edit on imsardine/dev-notes</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#sqlalchemy-domain-model">SQLAlchemy / Domain Model</a></li>
            <li class="second-level"><a href="#getting-started">新手上路 ??</a></li>
                
            <li class="second-level"><a href="#hybrid-attribute">Hybrid Attribute ??</a></li>
                
            <li class="second-level"><a href="#model-validation-wtform">Model 可以做 validation，可否直接產生 WTForm?</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="sqlalchemy-domain-model"><a href="../sqlalchemy/">SQLAlchemy</a> / Domain Model<a class="headerlink" href="#sqlalchemy-domain-model" title="Permanent link"> #</a></h1>
<ul>
<li><a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html">Object Relational Tutorial — SQLAlchemy 1.2 Documentation</a> One approaches the structure and content of data from the perspective of a USER-DEFINED DOMAIN MODEL which is transparently persisted and refreshed from its underlying storage model&rdquo;，而且連結還指向 Wikipedia 的 <a href="https://en.wikipedia.org/wiki/Domain_model">Domain model</a>，似乎把跟 database 對應的 user-defined class 當做 domain model 了?</li>
<li><a href="http://docs.sqlalchemy.org/en/latest/glossary.html#term-domain-model">Domain Model - Glossary — SQLAlchemy 1.2 Documentation</a> 這裡的說法 entities、attributes、relationships、constraints 跟 Wikipedia 已經對不起來了，反倒沒有提到 data + behavior 的重點?</li>
<li><a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#declare-a-mapping">Declare a Mapping - Object Relational Tutorial — SQLAlchemy 1.2 Documentation</a> 最後提到 mapped classes 被加工 (instrumented) 後跟一般 Python class 無異，也可以宣告其他 attribute、method；這一點對 domain model 很友善。</li>
<li><a href="https://docs.sqlalchemy.org/en/latest/orm/constructors.html">Constructors and Object Initialization — SQLAlchemy 1.3 Documentation</a> ORM 載資料時並不透過 constructor，所以 <code>__init__()</code> 可以自由安排 #ril</li>
</ul>
<h2 id="getting-started">新手上路 ??<a class="headerlink" href="#getting-started" title="Permanent link"> #</a></h2>
<p>參考資料：</p>
<ul>
<li>Flask Blueprints - Joel Perras - Google Books <a href="https://books.google.com.tw/books?id=SfSoCwAAQBAJ&amp;pg=PA38&amp;lpg=PA38&amp;dq=domain+modeling#v=onepage&amp;q=domain%20modeling&amp;f=false">https://books.google.com.tw/books?id=SfSoCwAAQBAJ&amp;pg=PA38&amp;lpg=PA38&amp;dq=domain+modeling#v=onepage&amp;q=domain%20modeling&amp;f=false</a> 提到 hybrid attributes 在 domain model 方面的應用 - Hybrid attributes are so named because they can provide distinctly different behaviors when invoked at the class level or instance level. The SQLAlchemy documentation is a great place to learn about the various roles that they can fulfill in your domain modeling</li>
<li>Types of Mappings — SQLAlchemy 1.2 Documentation <a href="http://docs.sqlalchemy.org/en/latest/orm/mapping_styles.html#classical-mapping">http://docs.sqlalchemy.org/en/latest/orm/mapping_styles.html#classical-mapping</a> Classical mapping 會不會更適合實作 domain model?</li>
<li><a href="http://docs.sqlalchemy.org/en/latest/orm/tutorial.html#create-an-instance-of-the-mapped-class">the <strong>init</strong>() method - Object Relational Tutorial — SQLAlchemy 1.2 Documentation</a> Instrumentation 會自動產生一個可以接受不同 column names 的 <code>__init__()</code>，不過我們還是可以自訂 constructor。</li>
</ul>
<h2 id="hybrid-attribute">Hybrid Attribute ??<a class="headerlink" href="#hybrid-attribute" title="Permanent link"> #</a></h2>
<ul>
<li>
<p><a href="https://docs.sqlalchemy.org/en/latest/orm/mapped_attributes.html#using-descriptors-and-hybrids">Using Descriptors and Hybrids - Changing Attribute Behavior — SQLAlchemy 1.3 Documentation</a></p>
<ul>
<li>
<p>A more comprehensive way to produce modified behavior for an attribute is to use descriptors. These are commonly used in Python using the <code>property()</code> function. The standard SQLAlchemy technique for descriptors is to create a plain descriptor, and to have it read/write from a MAPPED ATTRIBUTE with a different name. Below we illustrate this using Python 2.6-style properties:</p>
<pre><code>class EmailAddress(Base):
    __tablename__ = 'email_address'

    id = Column(Integer, primary_key=True)

    # name the attribute with an underscore,
    # different from the column name
    _email = Column("email", String)

    # then create an ".email" attribute
    # to get/set "._email"
    @property
    def email(self):
        return self._email

    @email.setter
    def email(self, email):
        self._email = email
</code></pre>
</li>
<li>
<p>The approach above will work, but there’s more we can add. While our <code>EmailAddress</code> object will shuttle the value through the email descriptor and into the <code>_email</code> mapped attribute, the class level <code>EmailAddress.email</code> attribute does not have the usual EXPRESSION SEMANTICS usable with <code>Query</code>. (不能用在 query 裡的意思) To provide these, we instead use the HYBRID EXTENSION as follows:</p>
<pre><code>from sqlalchemy.ext.hybrid import hybrid_property

class EmailAddress(Base):
    __tablename__ = 'email_address'

    id = Column(Integer, primary_key=True)

    _email = Column("email", String)

    @hybrid_property &lt;-- 從 @property 換成 @hybrid_property
    def email(self):
        return self._email

    @email.setter
    def email(self, email):
        self._email = email
</code></pre>
<p>The <code>.email</code> attribute, in addition to providing getter/setter behavior when we have an instance of <code>EmailAddress</code>, also provides a SQL expression when used at the CLASS LEVEL, that is, from the <code>EmailAddress</code> class directly:</p>
<pre><code>from sqlalchemy.orm import Session
session = Session()

SQLaddress = session.query(EmailAddress).\
                 filter(EmailAddress.email == 'address@example.com').\
                 one()

# SQL:
# SELECT address.email AS address_email, address.id AS address_id
# FROM address
# WHERE address.email = ? &lt;-- 跟 email (getter) 裡的邏輯無關
# ('address@example.com',)

address.email = 'otheraddress@example.com'
SQLsession.commit()
</code></pre>
</li>
<li>
<p>The <code>hybrid_property</code> also allows us to change the behavior of the attribute, including defining separate behaviors when the attribute is accessed at the INSTANCE LEVEL versus at the CLASS/EXPRESSION LEVEL, using the <code>hybrid_property.expression()</code> modifier. Such as, if we wanted to add a host name automatically, we might define TWO SETS of string manipulation logic:</p>
<p>所謂 class/expression level，是因為用 expression language 寫 query 時，都是用 <code>mapped_class.attribute</code>，要如何讓 SQLAlchemy 知道 attribute getter 有一些邏輯，在轉換過的 SQL 也套用相同的邏輯，這就是 <code>hybrid_property.expression()</code> 在做的事。</p>
<p>這也間接說明了，多包裝一層 property 或 hybrid property，並不會增加 query 的負擔，加上 <a href="https://docs.sqlalchemy.org/en/latest/orm/mapped_attributes.html#simple-validators">Simple Validators - Changing Attribute Behavior</a> 提到的 &ldquo;Validators, like all ATTRIBUTE EXTENSIONS, are only called by normal USERLAND CODE; they are not issued when the ORM is POPULATING the object:&rdquo;，就算是從 DB 載入資料也不會有多餘的運算。</p>
<pre><code>class EmailAddress(Base):
    __tablename__ = 'email_address'

    id = Column(Integer, primary_key=True)

    _email = Column("email", String)

    @hybrid_property
    def email(self):
        """Return the value of _email up until the last twelve
        characters."""

        return self._email[:-12]

    @email.setter
    def email(self, email):
        """Set the value of _email, tacking on the twelve character
        value @example.com."""

        self._email = email + "@example.com"

    @email.expression
    def email(cls):
        """Produce a SQL expression that represents the value
        of the _email column, minus the last twelve characters."""

        return func.substr(cls._email, 0, func.length(cls._email) - 12)
</code></pre>
<p>Above, accessing the <code>email</code> property of an instance of <code>EmailAddress</code> will return the value of the <code>_email</code> attribute, removing or adding the hostname <code>@example.com</code> from the value. When we query against the <code>email</code> attribute, a SQL FUNCTION is rendered which produces the same effect:</p>
<pre><code>address = session.query(EmailAddress).filter(EmailAddress.email == 'address').one()

# SQL:
# SELECT address.email AS address_email, address.id AS address_id
# FROM address
# WHERE substr(address.email, ?, length(address.email) - ?) = ?
# (0, 12, 'address')
</code></pre>
</li>
</ul>
</li>
<li>
<p><a href="https://docs.sqlalchemy.org/en/latest/orm/extensions/hybrid.html">Hybrid Attributes — SQLAlchemy 1.3 Documentation</a> #ril</p>
</li>
<li><a href="http://pynash.org/2013/03/01/Hybrid-Properties-in-SQLAlchemy/">Introductions to Hybrid Properties in SQLAlchemy - PyNash</a> (2013-03-01) #ril</li>
<li><a href="https://docs.sqlalchemy.org/en/latest/orm/mapped_sql_expr.html#using-a-hybrid">Using a Hybrid - SQL Expressions as Mapped Attributes — SQLAlchemy 1.2 Documentation</a> #ril</li>
</ul>
<h2 id="model-validation-wtform">Model 可以做 validation，可否直接產生 WTForm?<a class="headerlink" href="#model-validation-wtform" title="Permanent link"> #</a></h2>
<ul>
<li>WTForms-Alchemy — WTForms-Alchemy 0.16.5 documentation <a href="https://wtforms-alchemy.readthedocs.io/en/latest/">https://wtforms-alchemy.readthedocs.io/en/latest/</a> #ril</li>
</ul></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        
        
    </footer>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '..';
    </script>
    <!-- <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script> -->
    <script src="../js/base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"></script>
    <script src="../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>

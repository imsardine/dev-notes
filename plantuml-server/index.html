<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="canonical" href="https://imsardine.github.io/dev-notes/plantuml-server/">
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>PlantUML / Server - 建造以學習 | 在電梯裡遇見雙胞胎</title>
    

    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/3.003/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.min.css">
    <link href="../cinder_extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.28/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="..">建造以學習 | 在電梯裡遇見雙胞胎</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/imsardine/dev-notes/blob/source/docs/plantuml-server.md">Edit on imsardine/dev-notes</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#plantuml-server">PlantUML / Server</a></li>
            <li class="second-level"><a href="#cache">Cache ??</a></li>
                
        <li class="first-level "><a href="#reference">參考資料</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="plantuml-server"><a href="../plantuml/">PlantUML</a> / Server<a class="headerlink" href="#plantuml-server" title="Permanent link"> #</a></h1>
<ul>
<li>
<p><a href="http://plantuml.com/server">The servlet for server side</a> #ril</p>
</li>
<li>
<p><a href="https://docs.gitlab.com/ee/administration/integration/plantuml.html">PlantUML &amp; GitLab | GitLab</a></p>
<ul>
<li>
<p>Before you can enable PlantUML in GitLab; you need to set up your own PlantUML server that will generate the diagrams.</p>
<p>動態透過 PlantUML server 轉成圖形；實測下來，是由 browser 對 PlantUML server 發出請求，也就是 GitLab server 只幫忙把 diagram 的語法編進 URL。</p>
</li>
<li>
<p>With Docker, you can just run a container like this: <code>docker run -d --name plantuml -p 8080:8080 plantuml/plantuml-server:tomcat</code></p>
<p>The PlantUML URL will be the hostname of the server running the container.</p>
</li>
</ul>
</li>
<li>
<p><a href="http://plantuml.com/faq#3">How long do the images generated by PlantUML Server live for? - Frequently Asked Questions</a></p>
<ul>
<li>Links to png or svg generated by PlantUML Server are valid forever (that is as long as the server is up). However, WE DO NOT STORE ANY DIAGRAMS ON OUR SERVERS.</li>
<li>
<p>This may sound contradictory. It is not: the whole diagram is COMPRESSED INTO THE URL ITSELF. When the server receives the URL, it decompresses the URL to retrieve the diagram text and generates the image. There is no need to store anything. Even if the server is down, you can retrieve the diagram using the flag <code>-decodeurl</code> with the command line. Furthermore, the diagram data is stored in PNG metadata, so you can fetch it even from a downloaded image.</p>
<p>原來像 <a href="http://www.plantuml.com/plantuml/uml/SoWkIImgAStDuNBAJrBGjLDmpCbCJbMmKl18pSd9rr48po_AIL7aSaZDIm4g0W00">http://www.plantuml.com/plantuml/uml/SoWkIImgAStDuNBAJrBGjLDmpCbCJbMmKl18pSd9rr48po_AIL7aSaZDIm4g0W00</a> 這樣的 URL，其產生的圖形為 <a href="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuNBAJrBGjLDmpCbCJbMmKl18pSd9rr48po_AIL7aSaZDIm4g0W00">http://www.plantuml.com/plantuml/png/SoWkIImgAStDuNBAJrBGjLDmpCbCJbMmKl18pSd9rr48po_AIL7aSaZDIm4g0W00</a>，後面 <code>SoWkI...g0W00</code> 這一整串應該就是 <code>@startuml ... @enduml</code> 編碼的結果。</p>
</li>
<li>
<p>Occasionally we may activate HTTP traces on our server. This is mainly for performance issues (when we have some) to understand the traffic we get. Once the issue solved, we turn back off HTTP traces and we remove the logs.</p>
</li>
<li>Note that we are also counting the number of diagrams generated (printed at the home page) to measure general server load.</li>
<li>Concerning sensitive content: even if we do not store the generated diagrams, please be aware that all traffic goes through HTTP, so it&rsquo;s easy to catch. So you should probably install a LOCAL SERVER on your own network if you plan to generate diagrams with sensitive information.</li>
</ul>
</li>
<li>
<p><a href="https://hub.docker.com/r/plantuml/plantuml-server/">plantuml/plantuml-server - Docker Hub</a> #ril</p>
</li>
</ul>
<h2 id="cache">Cache ??<a class="headerlink" href="#cache" title="Permanent link"> #</a></h2>
<p>參考資料：</p>
<ul>
<li>
<p><a href="http://plantuml.com/faq#3">How long do the images generated by PlantUML Server live for? - Frequently Asked Questions</a></p>
<ul>
<li>
<p>Links to png or svg generated by PlantUML Server are valid forever (that is as long as the server is up). However, WE DO NOT STORE ANY DIAGRAMS ON OUR SERVERS.</p>
<p>因此快取肯定做在 client 端。</p>
</li>
</ul>
</li>
<li>
<p><a href="https://github.com/plantuml/plantuml-server/issues/4">Draw images for PlantUML markup reachable via URL? · Issue #4 · plantuml/plantuml-server</a> #ril</p>
<ul>
<li>
<p>arnaudroques (contributor): Yes, by default, PlantUML server sends some Cache-Control/public header for images. This makes sense for text diagram without <code>!include</code>.</p>
<p>We cannot simply remove it for every served image, but we could improve this behaviour: For example, if we detect some <code>!include</code> directive in the diagram, we could change the header to Cache-Control/no cache.</p>
<p>This is something we have ALREADY IMPLEMENTED very basically, see <a href="https://github.com/plantuml/plantuml/blob/master/src/net/sourceforge/plantuml/StringUtils.java#L333">https://github.com/plantuml/plantuml/blob/master/src/net/sourceforge/plantuml/StringUtils.java#L333</a> 但不是檢查有沒有 <code>!include</code> XD</p>
<p>So you can even check now is the following URL gives the right HTTP header <a href="http://www.plantuml.com/plantuml/png/AqijAixCpmC0">http://www.plantuml.com/plantuml/png/AqijAixCpmC0</a></p>
<pre><code>$ curl -I http://www.plantuml.com/plantuml/png/AqijAixCpmC0 # 確實沒有 Cache-Control header
HTTP/1.1 200 OK
Access-Control-Allow-Origin: *
Content-Type: image/png
X-PlantUML-Measure: 1/32/148
X-PlantUML-Diagram-Width: 481
X-PlantUML-Diagram-Height: 311
Content-Length: 20397
Server: PlantUML/0.6

$ java -jar plantuml.jar -decodeurl AqijAixCpmC0
@startuml
@startuml
version
@enduml
@enduml
No diagram found
</code></pre>
<p>做一些實驗確認加 <code>@startuml</code> 緊接著 <code>version</code> 的用法可以停用快取：</p>
<pre><code>$ cat cache.puml
@startuml
Bob -&gt; Alice : hello
@enduml

$ cat nocache.puml
@startuml
version
Bob -&gt; Alice : hello
@enduml

$ java -jar plantuml.jar -encodeurl cache.puml
SyfFKj2rKt3CoKnELR1Io4ZDoSa70000
No diagram found

$ java -jar plantuml.jar -encodeurl nocache.puml
AqijAixCp-DooazIqBLJSCp9J4vLi5B8ICt9oGS0
No diagram found

$ curl -I http://www.plantuml.com/plantuml/png/SyfFKj2rKt3CoKnELR1Io4ZDoSa70000 # cache
HTTP/1.1 200 OK
Date: Thu, 25 Apr 2019 03:14:51 GMT
Content-Type: image/png
Content-Length: 1514
Last-Modified: Sun, 13 May 2018 13:17:06 GMT
ETag: "5af83ad2-5ea"
Expires: Thu, 25 Apr 2019 23:30:00 GMT
Cache-Control: max-age=72909
Accept-Ranges: bytes
Server: PlantUML/0.6

$ curl -I http://www.plantuml.com/plantuml/png/AqijAixCp-DooazIqBLJSCp9J4vLi5B8ICt9oGS0 # no-cache
HTTP/1.1 400 Bad Request &lt;-- 因為 version 只能單獨使用?
Access-Control-Allow-Origin: *
Content-Type: image/png
X-PlantUML-Measure: 1/14/395
X-PlantUML-Diagram-Width: 565
X-PlantUML-Diagram-Height: 432
Content-Length: 26963
Server: PlantUML/0.6
</code></pre>
</li>
</ul>
</li>
</ul>
<h1 id="reference">參考資料<a class="headerlink" href="#reference" title="Permanent link"> #</a></h1>
<ul>
<li><a href="https://github.com/plantuml/plantuml-server">plantuml/plantuml-server - GitHub</a></li>
<li><a href="https://hub.docker.com/r/plantuml/plantuml-server/">plantuml/plantuml-server - Docker Hub</a></li>
</ul>
<p>工具：</p>
<ul>
<li><a href="http://www.plantuml.com/plantuml/uml/">Online Demo Server</a> 跑的正是 PlantUML Server</li>
<li><a href="https://plantuml-editor.kkeisuke.com/">PlantUML Editor</a></li>
<li><a href="https://liveuml.com/">LiveUML</a> - 自動刷新</li>
</ul></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        
        
    </footer>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '..';
    </script>
    <!-- <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script> -->
    <script src="../js/base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"></script>
    <script src="../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>

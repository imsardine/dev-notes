<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="canonical" href="https://imsardine.github.io/dev-notes/pyrollbar/">
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>pyrollbar - 建造以學習 | 在電梯裡遇見雙胞胎</title>
    

    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/3.003/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.min.css">
    <link href="../cinder_extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.28/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="..">建造以學習 | 在電梯裡遇見雙胞胎</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/imsardine/dev-notes/blob/source/docs/pyrollbar.md">Edit on imsardine/dev-notes</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#pyrollbar">pyrollbar</a></li>
            <li class="second-level"><a href="#getting-started">新手上路</a></li>
                
            <li class="second-level"><a href="#log-handler">Log Handler ??</a></li>
                
            <li class="second-level"><a href="#setup">安裝設置</a></li>
                
            <li class="second-level"><a href="#reference">參考資料</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="pyrollbar">pyrollbar<a class="headerlink" href="#pyrollbar" title="Permanent link"> #</a></h1>
<p>pyrollbar is a Python SDK for reporting exceptions, errors, and log messages to Rollbar.</p>
<h2 id="getting-started">新手上路<a class="headerlink" href="#getting-started" title="Permanent link"> #</a></h2>
<ul>
<li>
<p><a href="https://docs.rollbar.com/docs/python#section-quick-start">Quick start - Python</a></p>
<pre><code>import rollbar
rollbar.init('POST_SERVER_ITEM_ACCESS_TOKEN', 'production')  # access_token, environment

try:
    main_app_loop()
except IOError:
    rollbar.report_message('Got an IOError in the main loop', 'warning')
except:
    # catch-all
    rollbar.report_exc_info()
    # equivalent to rollbar.report_exc_info(sys.exc_info())
</code></pre>
<p>看起來 <code>rollbar</code> 像是個 singleton，<code>rollbar.init()</code> 並不會安插什麼 hook，還是要自己在 error handler 叫用 <code>rollbar.report_*()</code>。</p>
</li>
<li>
<p><a href="https://github.com/rollbar/pyrollbar/blob/v0.14.7/rollbar/__init__.py#L320">pyrollbar/__init__.py at v0.14.7 · rollbar/pyrollbar</a></p>
<p>就 <code>rollbar.init()</code> 傳入的 <code>access_token</code> 與 <code>environment</code> 而言，只是把它存在 global <code>SETTINGS</code> 而已：</p>
<pre><code>def init(access_token, environment='production', scrub_fields=None, url_fields=None, **kw):
    ...
    SETTINGS['access_token'] = access_token
    SETTINGS['environment'] = environment
</code></pre>
</li>
</ul>
<h2 id="log-handler">Log Handler ??<a class="headerlink" href="#log-handler" title="Permanent link"> #</a></h2>
<ul>
<li>
<p><a href="https://docs.rollbar.com/docs/python#section-django">Django - Configuration - Python</a></p>
<ul>
<li>
<p>If you&rsquo;d like to be able to use a Django <code>LOGGING</code> handler that could catch errors that happen OUTSIDE OF THE MIDDLEWARE and ship them to Rollbar, such as in celery job queue tasks that run in the background SEPARATE FROM WEB REQUESTS, do the following:</p>
<p>Add this to the <code>handlers</code> key:</p>
<pre><code>'rollbar': {
    'filters': ['require_debug_false'],
    'access_token': 'POST_SERVER_ITEM_ACCESS_TOKEN',
    'environment': 'production',
    'class': 'rollbar.logger.RollbarHandler'
},
</code></pre>
<p>Then add the handler to the <code>loggers</code> key values where you want it to fire off.</p>
<pre><code>'myappwithtasks': {
    'handlers': ['console', 'logfile', 'rollbar'],
    'level': 'DEBUG',
    'propagate': True,
},
</code></pre>
</li>
</ul>
</li>
<li>
<p><a href="https://github.com/rollbar/pyrollbar/blob/v0.14.7/rollbar/examples/flask/app.py">pyrollbar/app.py at v0.14.7 · rollbar/pyrollbar</a></p>
<pre><code>import logging

from flask import Flask

import rollbar
from rollbar.logger import RollbarHandler # (1)

ACCESS_TOKEN = 'ACCESS_TOKEN'
ENVIRONMENT = 'development'

rollbar.init(ACCESS_TOKEN, ENVIRONMENT)

logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)

# report WARNING and above to Rollbar
rollbar_handler = RollbarHandler(history_size=3) # (2)
rollbar_handler.setLevel(logging.WARNING)

# gather history for DEBUG+ log messages
rollbar_handler.setHistoryLevel(logging.DEBUG)   # (2)

# attach the history handler to the root logger
logger.addHandler(rollbar_handler)

app = Flask(__name__)

@app.route('/')
def root():
    logger.info('about to call foo()')
    try:
        foo()
    except:
        logger.exception('Caught exception') # (3)

    return '&lt;html&gt;&lt;body&gt;Hello World&lt;/body&gt;&lt;/html&gt;'

if __name__ == '__main__':
    app.run()
</code></pre>
<ol>
<li>雖然<a href="https://docs.rollbar.com/docs/python#section-django">官方文件</a> 是在 Django 看到 logging handler 的用法，但範例卻在 Flask。</li>
<li>什麼是 history ??</li>
<li>舉的例子不是很好懂，應該搭配 <code>@app.errorhandler(Exception)</code> 來實作會比較好。</li>
</ol>
</li>
<li>
<p><a href="https://github.com/rollbar/pyrollbar/blob/master/rollbar/logger.py">pyrollbar/logger.py at master · rollbar/pyrollbar</a></p>
<pre><code>Hooks for integrating with the python logging framework.

Usage:
    import logging
    from rollbar.logger import RollbarHandler

    rollbar.init('ACCESS_TOKEN', 'ENVIRONMENT')

    logger = logging.getLogger(__name__)
    logger.setLevel(logging.DEBUG)

    # report ERROR and above to Rollbar
    rollbar_handler = RollbarHandler()
    rollbar_handler.setLevel(logging.ERROR)

    # attach the handlers to the root logger
    logger.addHandler(rollbar_handler)
</code></pre>
</li>
<li>
<p><a href="https://github.com/rollbar/pyrollbar/blob/v0.14.7/rollbar/logger.py#L48">pyrollbar/logger.py at v0.14.7 · rollbar/pyrollbar</a></p>
<p>雖然 <code>RollbarHandler</code> 的 constructor 也提供 <code>access_token</code> 與 <code>environment</code> 參數，但內部也是轉呼叫 <code>rollbar.init()</code>：</p>
<pre><code>if access_token is not None:
    rollbar.init(access_token, environment, **kw)
</code></pre>
</li>
<li>
<p><a href="https://github.com/rollbar/pyrollbar/commits/v0.6.0/rollbar/logger.py">History for rollbar/logger.py - rollbar/pyrollbar</a></p>
<p>從 Git log 看來，<code>RollbarHandler</code> 第一次出現在 v0.6.0。</p>
</li>
</ul>
<h2 id="setup">安裝設置<a class="headerlink" href="#setup" title="Permanent link"> #</a></h2>
<ul>
<li>
<p><a href="https://docs.rollbar.com/docs/python#section-quick-start">Quick start - Python</a></p>
<ul>
<li>Install using pip:<pre><code>pip install rollbar
</code></pre>
</li>
</ul>
<p>Requirements</p>
<ul>
<li>Python 2.7, 3.3, 3.4, 3.5, or 3.6</li>
<li>requests 0.12+  &rarr; Python 內建對 HTTP 的支援應該是夠的</li>
<li>A Rollbar account</li>
</ul>
</li>
</ul>
<h2 id="reference">參考資料<a class="headerlink" href="#reference" title="Permanent link"> #</a></h2>
<ul>
<li><a href="https://docs.rollbar.com/docs/python">Python SDK - Rollbar</a></li>
<li><a href="https://github.com/rollbar/pyrollbar">rollbar/pyrollbar - GitHub</a></li>
</ul></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
        
        
    </footer>

    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '..';
    </script>
    <!-- <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script> -->
    <script src="../js/base.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"></script>
    <script src="../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
